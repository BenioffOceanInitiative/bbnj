---
title: "Explore prioritizr"
author: "Ben Best"
date: "`r Sys.Date()`"
#output: rmarkdown::html_vignette
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ../inst/bbnj.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  #collapse = TRUE,
  #comment = "#>",
  message = F
)
```

## Setup

```{r p}
suppressPackageStartupMessages({
  library(tidyverse)
  library(here)
  library(glue)
  library(raster)
  library(sf)
  library(leaflet)
  library(RColorBrewer)
  library(rasterVis)
  library(prioritizr) # install.packages("prioritizr")
  
  #library(bbnj)
  devtools::load_all()
})

dir_data       <- "~/Gdrive Ecoquants/projects/bbnj/data"
cell_res       <- 0.5  # n=  113,401
p_boundary_shp <- glue("{dir_data}/derived/boundary/high_seas.shp")
r_pu_id_tif    <- glue("{dir_data}/derived/boundary/high_seas_cellid_{cell_res}dd.tif")
```

## Planning Units

Using half-degree global raster (resolution of AquaMaps, GFW, ...).

```{r}
# get planning unit raster
r_pu_id <- raster(r_pu_id_tif)

pal <- colorRampPalette(brewer.pal(11, "Spectral"))
cols <- rev(pal(255))
plot(r_pu_id, col = cols, main="pu_id")
```

### PU Cost as Area

```{r}
r_pu_area <- area(r_pu_id) %>%  # in km2
  mask(r_pu_id)

plot(r_pu_area, col = cols, main="pu_area (km2)")
```

```{r}
A <- cellStats(r_pu_area, "sum")
r_pu_areas <- r_pu_area / A * 100
#cellStats(r_pu_areas, "sum") # 100

plot(r_pu_areas, col = cols, main="pu_areas (sums to 100)")
```


## Conservation Targets

### Biodiversity

All the species distribution data was generously provided as comma-seperated value (csv) files in a zip package `aquamaps_ver0816c.zip` by Kristin Kaschner and Cristina Garilao to Ben Best <ben@ecoquants.com> on Jun 21, 2018 from the extensive work available at <http://AquaMaps.org> to be fully cited [@kaschnerAquaMapsPredictedRange2016] whenever used. For details on generating indicators, see [Calculate Indicators • gmbi](https://marinebon.github.io/gmbi/articles/calc.html):

Note that a probability ≥ 0.5 was used to convert AquaMaps relative environmental suitability (RES) from continuous [0 - 1] to binary [0,1] [@kleinShortfallsGlobalProtected2015; @oharaAligningMarineSpecies2017].

- `nspp`: number of species, ie species richness

- `rls`: Red List Sum (RLS)

The Red List Sum (RLS) is the numerator from the Red List Index (RLI) ([@butchartImprovementsRedList2007; @juslenApplicationRedList2016]:

$$RLS = \sum_{i=1}^{n_{spp}} w_i$$

We will use only the numerator, the Red List Sum (RLS), of the Red List Index (RLI) to quantify the "endangeredness" of a cell without dilution from being in a species-rich place as the RLI does when averaging the extinction risk for all assessed species. For more details see [Calculate extinction risk - Calculate Indicators • gmbi](https://marinebon.github.io/gmbi/articles/calc.html#calculate-extinction-risk).

These indicators were calculated for all species as well as taxonomic groups defined in [Assign taxonomic groups - Calculate Indicators • gmbi](https://marinebon.github.io/gmbi/articles/calc.html#assign-taxonomic-groups).

With rasters from R package [marinebon/gmbi](https://github.com/marinebon/gmbi), mask rasters to high seas planning units and save into this R package:

```{r}
library(gmbi) # devtools::install_github("marinebon/gmbi")

dir_bio <- here("inst/data/biodiversity")
redo = F

tifs_gmbi <- list.files(system.file("rasters", package="gmbi"), full.names = T)
tifs_bbnj <- file.path(dir_bio, basename(tifs_gmbi))

if (!all(file.exists(tifs_bbnj)) | redo){
  
  for (i in 1:length(tifs_gmbi)){ # i=27
    
    tif_gmbi <- tifs_gmbi[i]
    tif_bbnj <- tifs_bbnj[i]
    
    r <- raster(tif_gmbi) %>% 
      mask(r_pu_id)
    
    # in some cases masking by high seas might return all NAs, in which case skip
    if (sum(!is.na(values(r))) == 0) next()
    
    writeRaster(r, tif_bbnj, overwrite=T)
  }
}

basename(tifs_bbnj)
```

### `nspp`, all taxa

```{r}
devtools::install_local("~/github/gmbi")
library(gmbi)

data(gmbi_indicators)
help(gmbi_indicators, package="gmbi")
data(package="gmbi")

names(gmbi_indicators)

tif <- system.file("data/biodiversity/nspp_all.tif", package="bbnj")
r_nspp_all <- raster(tif)
plot(r_nspp_all, col = cols, main="nspp, all taxa")
```

### `nspp`, all taxa, area scaled

```{r}
r_nspp_all_as <- area_scale_raster(r_nspp_all, r_pu_area)

plot(r_nspp_all_as, col = cols, main="nspp, all taxa, area scaled")
```

### `nspp`, by taxonomic group

```{r}
# get all tifs, except first one "nspp_all.tif"
tifs <- list.files(
  system.file("data/biodiversity", package="bbnj"), 
  "^nspp_.*.tif$", full.names = T)[-1]
s_nspp_groups <- stack(tifs)
names(s_nspp_groups) <- str_replace(names(s_nspp_groups), "nspp_", "")
plot(s_nspp_groups, col = cols)
```

### `rls`, all taxa

```{r}
tif <- system.file("data/biodiversity/rls_all.tif", package="bbnj")
r_rls_all <- raster(tif)
plot(r_rls_all, col = cols, main="rls, all taxa")
```

### `rls`, by taxonomic group

```{r}
# get all tifs, except first one "nspp_all.tif"
tifs <- list.files(
  system.file("data/biodiversity", package="bbnj"), 
  "^rls_.*.tif$", full.names = T)[-1]
s_nspp_groups <- stack(tifs)
names(s_nspp_groups) <- str_replace(names(s_nspp_groups), "rls_", "")
plot(s_nspp_groups, col = cols)
```

## Priotizr Scenarios

### p01: 10%, `r_nspp_all_as`

Maximize overall biodiversity, given a budget of 10% of all high seas area.

- [Add maximum utility objective — add_max_utility_objective • prioritizr](https://prioritizr.net/reference/add_max_utility_objective.html)

```{r p01}
p01 <- problem(r_pu_areas, r_nspp_all_as) %>%
  add_max_utility_objective(budget = 10) %>% # 10% of total high seas area
  add_gurobi_solver()

#devtools::load_all()
p01_sol <- solve_log(p01) # , "p01_log.txt", "p01_sol.tif")

plot(p01_sol, col = c("grey90", "darkgreen"), main = "Solution")

# area of solution
cellStats(r_pu_areas * p01_sol, "sum")

# calculate how well features are represented in the solution
feature_representation(p01, p01_sol)
```

### p02: 10%, `r_nspp_all_as`, 2 nbrs

Maximize overall biodiversity, given a budget of 10% of all high seas area, and require 2 rook-style neighbors for all cells in the solution.

```{r p02}
p02 <- problem(r_pu_areas, r_nspp_all_as) %>%
  add_neighbor_constraints(2) %>%            # require # of rook neighbors
  add_max_utility_objective(budget = 10) %>% # budget = % of total high seas area
  add_gurobi_solver()

# solve the problem
p02_sol <- solve(p02)

# plot solution
plot(p02_sol, col = c("grey90", "darkgreen"), main = "Solution")

# area of solution
cellStats(r_pu_areas * p02_sol, "sum")

# calculate how well features are represented in the solution
tbl_rep <- feature_representation(p02, p02_sol)
tbl_rep
```

The p02 result looks nearly same as p01, only tiny bit lower value in biodiversity held, presumably because of neighbor constraint.

### p03: 10%, `r_nspp_all_as`, 3 nbrs

Maximize overall biodiversity, given a budget of 10% of all high seas area, and require 4 rook-style neighbors for all cells in the solution.

```{r p03}
p03 <- problem(r_pu_areas, r_nspp_all_as) %>%
  add_neighbor_constraints(3) %>%            # require # of rook neighbors
  add_max_utility_objective(budget = 10) %>% # budget = % of total high seas area
  add_gurobi_solver()

# solve the problem
p03_sol <- solve(p03)

# plot solution
plot(p03_sol, col = c("grey90", "darkgreen"), main = "Solution")

# area of solution
cellStats(r_pu_areas * p03_sol, "sum")

# calculate how well features are represented in the solution
tbl_rep <- feature_representation(p03, p03_sol)
tbl_rep
```

Whoah, funk! Band around Antarctica with 3 neighbor constraint.

### p04: 10%, `r_nspp_all_as`, 4 nbrs

Maximize overall biodiversity, given a budget of 10% of all high seas area, and require 4 rook-style neighbors for all cells in the solution.

```{r p04}
p04 <- problem(r_pu_areas, r_nspp_all_as) %>%
  add_neighbor_constraints(3) %>%            # require # of rook neighbors
  add_max_utility_objective(budget = 10) %>% # budget = % of total high seas area
  add_gurobi_solver()

# solve the problem
p04_sol <- solve(p04)

# plot solution
plot(p04_sol, col = c("grey90", "darkgreen"), main = "Solution")

# area of solution
cellStats(r_pu_areas * p04_sol, "sum")

# calculate how well features are represented in the solution
tbl_rep <- feature_representation(p04, p04_sol)
tbl_rep
```

Whoah, funk! Whole ocean with 4 neighbor constraint.

### p05: 10%, `r_nspp_all_as`, blm(0.1,1)

Maximize overall biodiversity, given a budget of 10% of all high seas area, and enforce boundary length modifier.

- [Conservation problem penalties — penalties • prioritizr](https://prioritizr.net/reference/penalties.html)
- [Add boundary penalties — add_boundary_penalties • prioritizr](https://prioritizr.net/reference/add_boundary_penalties.html)

This scenario takes too long to run, so caching.

```{r p05, eval=F}
p05 <- problem(r_pu_areas, r_nspp_all_as) %>%
  add_boundary_penalties(0.1, 1) %>%         # boundary penalty (penalty, edge_factor)
  add_max_utility_objective(budget = 10) %>% # budget = % of total high seas area
  add_gurobi_solver()

# solve the problem
p05_sol <- solve(p05)

# plot solution
plot(p05_sol, col = c("grey90", "darkgreen"), main = "Solution")

# area of solution
cellStats(r_pu_areas * p05_sol, "sum")

# calculate how well features are represented in the solution
tbl_rep <- feature_representation(p05, p05_sol)
tbl_rep
```

Whoah, funk! Whole ocean with 4 neighbor constraint.

## TODO: near-term

1. [add_locked_out_constraints()](https://prioritizr.net/reference/add_locked_out_constraints.html) for mining leased areas
1. Explore [Solution portfolios](https://prioritizr.net/reference/portfolios.html) solves for stack of alternative raster solutions.
1. Explore [add_loglinear_targets()](https://prioritizr.net/reference/add_loglinear_targets.html)

