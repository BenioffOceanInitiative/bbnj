---
title: "map layers"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

```{r layers}
library(prioritizr) # devtools::load_all("~/github/prioritizr")
#library(bbnj)       # 
devtools::load_all() # setwd(here()); devtools::install_local(force=T) 
# devtools::install_github("ecoquants/bbnj")
library(raster)
library(sf)
library(dplyr)
library(readr)
library(ggplot2)
library(stringr)
library(glue)
library(here)
library(fs)
library(units)
library(knitr)
library(formattable)
library(lwgeom)
library(RColorBrewer)
area   = raster::area
select = dplyr::select

# set rainbow color palette
pal <- colorRampPalette(brewer.pal(11, "Spectral"))
cols <- rev(pal(255))

# variables ----
prjres     <- "_mol50km" # prjres in: View(projections_tbl)

P <- projections_tbl %>% filter(prjres == !!prjres)

# planning unit: ----
r_pu_id <- get_d_prjres("r_pu_id", prjres) # plot(r_pu_id)
r_pu <- setValues(r_pu_id, 1) %>% 
  mask(r_pu_id) # plot(r_pu)

# input layers ----

# biodiversity: now, not 2100 ----
s_bio_gmbi <- get_gmbi_grpsmdl_prjres("groups02", prjres)
  lyrs_bio_now <- names(s_bio_gmbi) %>% 
  setdiff(str_subset(names(s_bio_gmbi), "rli")) %>% 
  setdiff(str_subset(names(s_bio_gmbi), "rls"))
s_bio_now <- subset(s_bio_gmbi, lyrs_bio_now)

  #add red list sum for all species as separate layer
rls_all <- get_gmbi_grpsmdl_prjres("groups00", prjres) %>% 
  subset("groups00_rls_all")

# features ----
s_seamounts <- get_d_prjres("s_phys_seamounts",prjres)
lu_seamounts <- c(lteq200m="0to200",gt200lteq800m="gt200to800",gt800m="gt800")
lbls_seamounts <- sprintf("phys_seamounts_%sm", lu_seamounts[names(s_seamounts)])

s_features <- stack(
  get_d_prjres("r_vgpm", prjres),
  s_bio_now,
  rls_all,
  #raster(s_fish_gfw, "mean_scaled_profits_with_subsidies") %>%
  #    gap_fill_raster(r_mask=r_pu_id) %>%
  #    rescale_raster(inverse=T),
  #raster(s_fish_ubc, "mcp_2004"),
  s_seamounts,
  get_d_prjres("r_phys_vents",prjres),
  get_d_prjres("r_phys_scapes_hetero",prjres))

names(s_features) <- c(
  "bio_vgpm",
  gsub("^.*?_","",names(s_bio_now)),
  "rls_all",
  #"fish_profit.subs"
  #"fish_mcp.2004",
  lbls_seamounts,
  "phys_vents",
  "scapes_hetero")
```

```{r}
dir_png <- here("inst/scripts/map_layers")
redo    <- T
  
cell_km2 <- prod(res(r_pu)) %>% as_units("m2") %>% set_units("km2")
hs_ncells  <- length(na.omit(values(r_pu_id)))
hs_areakm2 <- hs_ncells * cell_km2

countries <- rnaturalearth::ne_countries(returnclass = "sf") %>%
  st_transform(P$epsg)
graticules <- st_graticule(countries)

summary30pct_csv <- glue("{dir_png}/_summary30pct.csv")

# TODO
for (i in 1:nlayers(s_features)){ # i = 1
#for (i in 1:5){ # i = 1
  
  r   <- raster(s_features, i)
  lyr <- names(s_features)[i]
  
  r_tif      <- glue("{dir_png}/{lyr}.tif")
  map_png    <- glue("{dir_png}/{lyr}_map.png")
  map30_png  <- glue("{dir_png}/{lyr}_map30.png")
  hist30_png <- glue("{dir_png}/{lyr}_hist30.png")
  message(glue("{i}/{nlayers(s_features)}: {lyr}"))
  
  P   <- get_tif_projection(r_tif)
  
  # write raster ----
  if (!file.exists(r_tif)){
    message("  writeRaster")
    writeRaster(r, r_tif)
  }

  # values ----
  v     <- values(r) %>% na.omit() %>% sort(decreasing = T)
  d <- tibble(v = v) %>% 
    filter(v > 0) %>% 
    mutate(
      v_cumsum    = cumsum(v),
      i           = 1:length(v),
      cumarea_km2 = i * cell_km2 %>% drop_units(),
      pct_totval  = v_cumsum/sum(v) * 100,
      pct_hsarea  = cumarea_km2/hs_areakm2 %>% drop_units() * 100)
  
  d_30 <- d %>% 
    filter(v_cumsum <= sum(v)*.3)
  
  v_at30     <- min(d_30$v)
  pcths_at30 <- max(d_30$pct_hsarea)
  title  <- glue("{lyr} â€” 30%: {round(pcths_at30, digits=2)}% hs >= {signif(v_at30)}")
  
  D_i <- tibble(
    lyr        = lyr,
    v_at30     = v_at30,
    pcths_at30 = pcths_at30)
  
  if (!file.exists(summary30pct_csv)){
    write_csv(D_i, summary30pct_csv)
  } else {
    read_csv(summary30pct_csv) %>% 
      filter(lyr != !!lyr) %>% 
      bind_rows(D_i) %>% 
      write_csv(summary30pct_csv)
  }
  
  # hist ----
  if (!file.exists(hist30_png) | redo){
    message("  hist30_png")
    #png(hist30_png, width=480*4, height = 480*4, res=300, units='px')
    p <- ggplot(d, aes(x=pct_hsarea, y=pct_totval)) + 
      geom_area(fill="gray70", color=NA) + 
      geom_area(data=d_30, aes(x=pct_hsarea, y=pct_totval), fill="gray10", color=NA) + 
      scale_fill_distiller("spectral") +
      theme_light() + 
      coord_cartesian(expand = F) +
      #scale_x_continuous(labels = scales::percent_format()) %>% 
      scale_x_continuous(labels = scales::percent_format(accuracy = 3)) %>% 
      scale_y_continuous(labels = scales::percent_format()) %>% 
      labs(
        title = title, 
        x="% high seas area", y="% total value")
    ggsave(
      hist30_png,
      p, 
      "png", width=6.4, height=6.4, dpi=300, units='in')
    #dev.off()
  }
  
  # map 30 ----
  if (!file.exists(map30_png)){
    message("  map30_png")
    png(map30_png, width=480*4, height = 480*4, res=300, units='px')
    
    #plot(r)
    r_v <- mask(r, r >= v_at30, maskvalue=0)
    plot(r, col = scales::alpha(cols, 0.3), legend=F, axes=F, box=F, main=title)
    plot(r_v, col = cols, add=T, legend=T)
    plot(st_geometry(countries), add=T, col=gray(0.8), border=gray(0.7), lwd=0.5)
    plot(st_geometry(graticules), add=T, col=gray(0.6), lwd=0.5)
    
    dev.off()
    map30_png %>%
      magick::image_read() %>% magick::image_trim() %>%
      magick::image_write(map30_png)
  }
  
  # map ----
  if (!file.exists(map_png)){
    message("  map_png")
    png(map_png, width=480*4, height = 480*4, res=300, units='px')
    
    #table(values(r))
    plot(r, col = cols, legend=T, axes=F, box=F, main=lyr)
    plot(st_geometry(countries), add=T, col=gray(0.8), border=gray(0.7), lwd=0.5)
    plot(st_geometry(graticules), add=T, col=gray(0.6), lwd=0.5)
    
    dev.off()
    map_png %>%
      magick::image_read() %>% magick::image_trim() %>%
      magick::image_write(map_png)
  }
}
```

```{r}
D <- read_csv(summary30pct_csv)

if (exists("s_b")) rm(s_b)
r_sol <- r_pu - 1 # plot(R_b)
for (i in 1:nlayers(s_features)){ # i = 3
  
  r <- s_features[[i]]
  lyr <- names(s_features)[i]
  
  v_at30 <- D %>% 
    filter(lyr == !!lyr) %>% 
    pull(v_at30)
  
  r_sol[r >= v_at30] <- 1
  
  sol_areakm2  <- sum(values(r_sol), na.rm = T) * cell_km2
  pct_sol_hs <-  sol_areakm2 / hs_areakm2 * 100 # 84.47849 % high seas
  title <- glue("{i}/{nlayers(s_features)}: +{lyr}, {round(pct_sol_hs, digits=2)}% hs")
  
  plot(r_sol, main = title)
}
sol30_tif <- glue("{dir_png}/sol30.tif")
sol30_map_png <- glue("{dir_png}/sol30_map.png")

writeRaster(r_sol, sol30_tif)

png(sol30_map_png, width=480*4, height = 480*4, res=300, units='px')
#table(values(r))
plot(r_sol, legend=F, axes=F, box=F)
plot(st_geometry(countries), add=T, col=gray(0.8), border=gray(0.7), lwd=0.5)
plot(st_geometry(graticules), add=T, col=gray(0.6), lwd=0.5)
dev.off()
sol30_map_png %>%
  magick::image_read() %>% magick::image_trim() %>%
  magick::image_write(sol30_map_png)
```

