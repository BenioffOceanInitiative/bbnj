---
title: "prioritizr"
author: "Ben Best"
date: "12/14/2018"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Gurobi setup

* [Gurobi Installation Guide â€¢ prioritizr](https://prioritizr.net/articles/gurobi_installation.html)
* [Software Installation Guide](http://www.gurobi.com/documentation/8.0/quickstart_mac/software_installation_guid.html)

- `~/Google Drive/projects/bbnj/software/gurobi_optimizer/gurobi8.1.0_mac64.pkg`

- By default, the installer will place the Gurobi 8.1.0 files in `/Library/gurobi810/mac64`

```bash
grbgetkey `cat ~/private/gurobi_key`
```

- saved license to `/Users/bbest/gurobi.lic`

Testing: [Gurobi Optimizer Quick Start Guide - Mac OS: Software Installation Guide: Solving a Simple Model - The Gurobi Command Line: Solving the model using the Gurobi command-line interface](http://www.gurobi.com/documentation/8.1/quickstart_mac/solving_the_model_using_th.html)


- See examples in `/Library/gurobi810/mac64/examples` and described in [Example Code and Optimization Model Overview - Gurobi](http://www.gurobi.com/resources/examples/example-models-overview)

```bash
gurobi_cl /Library/gurobi810/mac64/examples/data/coins.lp
```

Install R interface, per [Solving the model using the Gurobi command-line interface: Gurobi Optimizer Example Tour: Gurobi Optimizer Quick Start Guide - Mac OS: R Interface: Installing the R Package](http://www.gurobi.com/documentation/8.1/quickstart_mac/r_installing_the_r_package.html):

```{r, eval=F}
tgz <- list.files('/Library/gurobi810/mac64/R', '.*tgz$', full.names = T)
install.packages(tgz, repos=NULL)

install.packages("slam", repos = "https://cloud.r-project.org")
```

Try out gurobi in R:
```{r}
suppressPackageStartupMessages({
  library('gurobi')
})

model <- list()

model$A          <- matrix(c(1,2,3,1,1,0), nrow=2, ncol=3, byrow=T)
model$obj        <- c(1,1,2)
model$modelsense <- 'max'
model$rhs        <- c(4,1)
model$sense      <- c('<', '>')
model$vtype      <- 'B'

params <- list(OutputFlag=0)

#result <- gurobi(model, params)
result <- gurobi(model, list())

print('Solution:')
print(result$objval)
print(result$x)
```


## Prioritizr

[Solving a prioritzr problem with Gurobi](https://prioritizr.net/articles/gurobi_installation.html#solving-a-prioritzr-problem-with-gurobi)

```{r}
suppressPackageStartupMessages({
  library(prioritizr) # install.packages("prioritizr")
})

# formulate the problem
p <- problem(sim_pu_raster, sim_features) %>%
     add_min_set_objective() %>%
     add_relative_targets(0.1) %>%
     add_gurobi_solver()

# solve the problem
s <- solve(p)

# plot solution
plot(s, col = c("grey90", "darkgreen"), main = "Solution",
     xlim = c(-0.1, 1.1), ylim = c(-0.1, 1.1))
```

## Simple BBNJ

```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(glue)
  library(raster)
  library(sf)
  library(leaflet)
  library(RColorBrewer)
  library(rasterVis)
  library(prioritizr) # install.packages("prioritizr")
  
  #library(bbnj)
  devtools::load_all()
})


dir_data <- "~/Google Drive/projects/bbnj/data/derived"
cell_res     <- 0.5  # n=  113,401
p_boundary_shp <- file.path(
  dir_data, glue("boundary/high_seas.shp"))
r_pu_tif <- file.path(
  dir_data, glue("boundary/high_seas_cellid_{cell_res}dd.tif"))

# get planning unit raster
r_pu <- raster(r_pu_tif)

pal <- colorRampPalette(brewer.pal(11, "Spectral"))
cols <- rev(pal(255))
plot(r_pu, col = cols, main="pu")

# get biodiversity features
bio_tifs <- list.files(
  file.path(dir_data, "biodiversity"), 
  "spp_.*_be_0\\.5dd\\.tif", full.names = T)

bio_vars <- tibble(
  tif = bio_tifs,
  var = str_replace(basename(tif), "spp_(.*)_be_0\\.5dd\\.tif", "\\1")) %>% 
  mutate(
    var = recode(var, `tunas.&.billfishes`="tunas.billfishes")) %>% 
  pull(var)

s_bio <- stack(bio_tifs)
names(s_bio) <- bio_vars

#plot(s_bio, col = cols, main="spp")
levelplot(s_bio, main="spp")

# formulate the problem
# TODO: check that s_bio being continuous is ok, and not binary
p <- problem(r_pu, s_bio) %>%
     add_min_set_objective() %>%
     add_relative_targets(0.1) %>%
     add_gurobi_solver()

# solve the problem
r_sol <- solve(p)

# plot solution
plot(r_sol, col = c("grey90", "darkgreen"), main = "Solution")

# devtools::load_all()
qmap_r(r_sol, "Solution", na0=T)
```

TODO: show pretty stack like

[Plot many rasters on the same graph, one on top of the other, using a certain angle in R - Geographic Information Systems Stack Exchange](https://gis.stackexchange.com/questions/237203/plot-many-rasters-on-the-same-graph-one-on-top-of-the-other-using-a-certain-an)

![](https://i.stack.imgur.com/yyoHW.png)

